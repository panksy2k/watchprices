---
- name: Deploy watchprices application
  hosts: watchprices
  vars:
    project_dir: /root/Projects/watchprices
    frontend_dir: /root/Projects/watchprices/frontend
    keystore_path: /root/Projects/certificates/letsencrypt-watchprices-keystore.p12
    keystore_secret: changeit
    mongo_host: localhost
    mongo_port: 27017
    mongo_database: productdb
    origin: https://github.com/panksy2k/watchprices.git

  tasks:
    - name: Pull latest code from git
      git:
        repo: "{{ origin }}"
        dest: "{{ project_dir }}"
        version: main
        update: yes
      ignore_errors: no

    - name: Git pull origin main
      shell: git pull origin main
      args:
        chdir: "{{ project_dir }}"

    - name: Build frontend with npm
      shell: npm run build
      args:
        chdir: "{{ frontend_dir }}"

    - name: Build backend with Maven
      shell: /root/.sdkman/candidates/maven/current/bin/mvn clean package -DskipTests
      args:
        chdir: "{{ project_dir }}"
      environment:
        JAVA_HOME: /root/.sdkman/candidates/java/current

    - name: Kill existing MainVerticle process
      shell: pkill -f MainVerticle || true
      ignore_errors: yes

    - name: Wait for process to terminate
      pause:
        seconds: 3

    - name: Start the application
      shell: |
        nohup /root/.sdkman/candidates/maven/current/bin/mvn \
          -DSERVER_KEYSTORE_PATH={{ keystore_path }} \
          -DMONGO_HOST={{ mongo_host }} \
          -DMONGO_PORT={{ mongo_port }} \
          -DMONGO_DATABASE={{ mongo_database }} \
          -DSERVER_KEYSTORE_SECRET={{ keystore_secret }} \
          -DMONGO_CONNECTION_STRING=mongodb://{{ mongo_host }}:{{ mongo_port }} \
          vertx:run > /tmp/watchprices.log 2>&1 &
      args:
        chdir: "{{ project_dir }}"
      environment:
        JAVA_HOME: /root/.sdkman/candidates/java/current
      async: 10
      poll: 0

    - name: Verify application started
      shell: sleep 5 && ps -ef | grep -i MainVerticle | grep -v grep
      register: process_check
      ignore_errors: yes

    - name: Display process status
      debug:
        msg: "Application started successfully"
      when: process_check.rc == 0
